# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Single-host Ansible project deploying Wazuh SIEM via Docker Compose on `wazuh.local.iamrobertyoung.co.uk`. Secrets are stored in AWS SSM Parameter Store and managed via Terraform.

## Key Commands

All commands require AWS credentials via aws-vault for SSM parameter lookups.

```bash
# Test connectivity
aws-vault exec iamrobertyoung:home-assistant-production:p -- ansible wazuh -m ping

# Run full playbook
aws-vault exec iamrobertyoung:home-assistant-production:p -- ansible-playbook playbooks/site.yml

# Run specific role only
aws-vault exec iamrobertyoung:home-assistant-production:p -- ansible-playbook playbooks/site.yml --tags wazuh

# Install external dependencies (roles)
aws-vault exec iamrobertyoung:home-assistant-production:p -- ansible-galaxy install -r requirements.yml -p .roles

# Create new custom role
aws-vault exec iamrobertyoung:home-assistant-production:p -- ansible-galaxy init roles/role_name
```

### Terraform (SSM Password Management)
```bash
cd terraform
aws-vault exec iamrobertyoung:home-assistant-production:p -- terraform init
aws-vault exec iamrobertyoung:home-assistant-production:p -- terraform apply
```

## Architecture

### Deployment Stack
The main playbook (`playbooks/site.yml`) applies these roles in order:
1. `configure-system` - Base system configuration
2. `shell` - Shell setup for users (noxious, root)
3. `docker` - Docker installation
4. `telegraf` - Metrics collection to InfluxDB
5. `step-ca-client` - TLS certificates from Step CA
6. `syslog` - Syslog configuration
7. `wazuh` - Wazuh SIEM deployment (Docker Compose with systemd service)

### Wazuh Role Structure
The `roles/wazuh` role deploys Wazuh via Docker Compose:
- `tasks/prerequisites.yml` - System preparation
- `tasks/certificates.yml` - Step CA certificate provisioning
- `tasks/deployment.yml` - Docker Compose and systemd service setup
- `tasks/backup.yml` - Automated S3 backup configuration
- `tasks/finalize.yml` - Post-deployment tasks

Installation directory: `/opt/wazuh`

### Secrets Management
Passwords are auto-generated by Terraform and stored in AWS SSM (region: eu-west-2):
- `/home-server/wazuh-indexer-password`
- `/home-server/wazuh-api-password`
- `/home-server/wazuh-kibana-password`

Ansible retrieves them via `lookup('amazon.aws.aws_ssm', ...)`.

### External Dependencies
Dependencies in `requirements.yml` are installed to `.roles/` (gitignored):
- `configure-system` role from GitHub
- `shell` role from GitHub
- `docker` role from GitHub
- `telegraf` role from GitHub
- `step-ca-client` role from GitHub
- `syslog` role from GitHub

### Available Tags
Run specific parts with `--tags`: `configure-system`, `shell`, `docker`, `telegraf`, `step-ca-client`, `syslog`, `wazuh`, `prerequisites`, `certificates`, `deployment`, `backup`

### Tool Versions (mise.toml)
- ansible 13.1.0
- terraform 1.14.3
- pipx 1.8.0
- uv 0.9.18
