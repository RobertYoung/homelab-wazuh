---
# Wazuh Certificate Management using Step CA and systemd
# Systemd services handle all certificate generation and renewal

- name: Create SSL certificates directory
  become: true
  ansible.builtin.file:
    path: "{{ wazuh_config_dir }}/wazuh_indexer_ssl_certs"
    state: directory
    mode: '0755'

- name: Copy Step CA root certificate
  become: true
  ansible.builtin.copy:
    src: /root/.step/certs/root_ca.crt
    dest: "{{ wazuh_config_dir }}/wazuh_indexer_ssl_certs/root-ca.pem"
    owner: root
    group: root
    mode: '0644'
    remote_src: true

- name: Copy Step CA root certificate for manager
  become: true
  ansible.builtin.copy:
    src: /root/.step/certs/root_ca.crt
    dest: "{{ wazuh_config_dir }}/wazuh_indexer_ssl_certs/root-ca-manager.pem"
    owner: root
    group: root
    mode: '0644'
    remote_src: true

- name: Create Step CA certificates directory
  become: true
  ansible.builtin.file:
    path: "{{ wazuh_certs_dir }}/step-ca"
    state: directory
    owner: "1000"
    group: "1000"
    mode: '0500'

# Clean up old template-based systemd services
- name: Stop and disable old template-based timers
  become: true
  ansible.builtin.systemd:
    name: "wazuh-cert-renewer@{{ item }}.timer"
    state: stopped
    enabled: false
  loop:
    - indexer
    - manager
    - dashboard-backend
    - admin
    - dashboard-frontend
  failed_when: false

- name: Remove old template-based systemd service file
  become: true
  ansible.builtin.file:
    path: /etc/systemd/system/wazuh-cert-renewer@.service
    state: absent

- name: Remove old template-based systemd timer file
  become: true
  ansible.builtin.file:
    path: /etc/systemd/system/wazuh-cert-renewer@.timer
    state: absent

- name: Remove old renewal script
  become: true
  ansible.builtin.file:
    path: "{{ wazuh_install_dir }}/scripts/renew-cert.sh"
    state: absent

- name: Reload systemd daemon after cleanup
  become: true
  ansible.builtin.systemd:
    daemon_reload: true

- name: Create certificate renewal scripts directory
  become: true
  ansible.builtin.file:
    path: "{{ wazuh_install_dir }}/scripts"
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Install certificate renewal script
  become: true
  ansible.builtin.template:
    src: renew-certs.sh.j2
    dest: "{{ wazuh_install_dir }}/scripts/renew-certs.sh"
    owner: root
    group: root
    mode: '0755'

- name: Install Step CA certificate renewal systemd service
  become: true
  ansible.builtin.template:
    src: wazuh-cert-renewer.service.j2
    dest: /etc/systemd/system/wazuh-cert-renewer.service
    owner: root
    group: root
    mode: '0644'
  register: renewal_service

- name: Install Step CA certificate renewal systemd timer
  become: true
  ansible.builtin.template:
    src: wazuh-cert-renewer.timer.j2
    dest: /etc/systemd/system/wazuh-cert-renewer.timer
    owner: root
    group: root
    mode: '0644'
  register: renewal_timer

- name: Reload systemd daemon
  become: true
  ansible.builtin.systemd:
    daemon_reload: true
  when: renewal_service.changed or renewal_timer.changed

- name: Trigger initial certificate generation
  become: true
  ansible.builtin.systemd:
    name: wazuh-cert-renewer.service
    state: started

- name: Enable and start Step CA certificate renewal timer
  become: true
  ansible.builtin.systemd:
    name: wazuh-cert-renewer.timer
    enabled: true
    state: started
