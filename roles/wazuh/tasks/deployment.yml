---
# Create configuration directory structure
- name: Create Wazuh configuration subdirectories
  become: true
  ansible.builtin.file:
    path: "{{ wazuh_config_dir }}/{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop:
    - wazuh_cluster
    - wazuh_indexer
    - wazuh_dashboard

# Copy manager configuration
- name: Copy Wazuh manager configuration
  become: true
  ansible.builtin.copy:
    src: files/wazuh_manager.conf
    dest: "{{ wazuh_config_dir }}/wazuh_cluster/wazuh_manager.conf"
    owner: root
    group: root
    mode: '0644'

# Copy indexer configurations
- name: Copy Wazuh indexer configuration
  become: true
  ansible.builtin.copy:
    src: files/wazuh.indexer.yml
    dest: "{{ wazuh_config_dir }}/wazuh_indexer/wazuh.indexer.yml"
    owner: root
    group: root
    mode: '0644'

- name: Copy indexer internal users configuration
  become: true
  ansible.builtin.copy:
    src: files/internal_users.yml
    dest: "{{ wazuh_config_dir }}/wazuh_indexer/internal_users.yml"
    owner: root
    group: root
    mode: '0644'

# Copy dashboard configurations
- name: Copy OpenSearch Dashboards configuration
  become: true
  ansible.builtin.copy:
    src: files/opensearch_dashboards.yml
    dest: "{{ wazuh_config_dir }}/wazuh_dashboard/opensearch_dashboards.yml"
    owner: root
    group: root
    mode: '0644'

- name: Copy Wazuh dashboard configuration
  become: true
  ansible.builtin.template:
    src: templates/wazuh.yml.j2
    dest: "{{ wazuh_config_dir }}/wazuh_dashboard/wazuh.yml"
    owner: root
    group: root
    mode: '0644'

# Copy environment variable files
- name: Copy manager environment variables
  become: true
  ansible.builtin.template:
    src: templates/manager.env.j2
    dest: "{{ wazuh_install_dir }}/manager.env"
    owner: root
    group: root
    mode: '0600'

- name: Copy indexer environment variables
  become: true
  ansible.builtin.template:
    src: templates/indexer.env.j2
    dest: "{{ wazuh_install_dir }}/indexer.env"
    owner: root
    group: root
    mode: '0600'

- name: Copy dashboard environment variables
  become: true
  ansible.builtin.template:
    src: templates/dashboard.env.j2
    dest: "{{ wazuh_install_dir }}/dashboard.env"
    owner: root
    group: root
    mode: '0600'

# Copy Docker Compose file
- name: Copy Docker Compose template
  become: true
  ansible.builtin.template:
    src: templates/docker-compose.yml.j2
    dest: "{{ wazuh_install_dir }}/docker-compose.yml"
    owner: root
    group: root
    mode: '0644'

# Install systemd service for Wazuh
- name: Install Wazuh systemd service
  become: true
  ansible.builtin.template:
    src: wazuh.service.j2
    dest: /etc/systemd/system/wazuh.service
    owner: root
    group: root
    mode: '0644'
  register: wazuh_service

- name: Reload systemd daemon
  become: true
  ansible.builtin.systemd:
    daemon_reload: true
  when: wazuh_service.changed

# Deploy Wazuh
- name: Enable and start Wazuh service
  become: true
  ansible.builtin.systemd:
    name: wazuh
    enabled: true
    state: started
  register: wazuh_deployment

- name: Wait for Wazuh Indexer port to be listening
  ansible.builtin.wait_for:
    host: localhost
    port: "{{ wazuh_indexer_port }}"
    delay: 10
    timeout: 300
    state: started
  when: wazuh_deployment.changed

- name: Wait for indexer to be ready
  ansible.builtin.pause:
    seconds: 30
  when: wazuh_deployment.changed

- name: Wait for services to stabilize
  ansible.builtin.pause:
    seconds: 10
  when: wazuh_deployment.changed

- name: Wait for Wazuh Manager API to be healthy
  ansible.builtin.wait_for:
    host: localhost
    port: "{{ wazuh_api_port }}"
    delay: 10
    timeout: 300
    state: started
  when: wazuh_deployment.changed

- name: Wait for Wazuh Dashboard to be healthy
  ansible.builtin.wait_for:
    host: localhost
    port: "{{ wazuh_dashboard_port }}"
    delay: 10
    timeout: 300
    state: started
  when: wazuh_deployment.changed
