#!/bin/bash
# Certificate renewal script for Wazuh using Step CA
# Renewals use mTLS - the existing certificate authenticates to the CA
# No password is needed for renewal (password only used for initial creation via Ansible)
set -euo pipefail

# Common configuration
CERT_DIR="{{ wazuh_config_dir }}/wazuh_indexer_ssl_certs"
FRONTEND_CERT_DIR="{{ wazuh_certs_dir }}/step-ca"
CERT_OWNER="1000"
CERT_GROUP="1000"

# Track which containers need restart
RESTART_INDEXER=0
RESTART_MANAGER=0
RESTART_DASHBOARD=0

# Function to check if certificate needs renewal
needs_renewal() {
  local cert_path="$1"
  if [ ! -f "$cert_path" ]; then
    echo "Certificate $cert_path does not exist - must be created via Ansible"
    return 1  # Don't try to renew non-existent cert
  fi
  if /usr/bin/step certificate needs-renewal "$cert_path"; then
    return 0  # Cert needs renewal
  fi
  return 1  # Cert is still valid
}

# Function to check if container exists
container_exists() {
  local container_name="$1"
  /usr/bin/docker ps -a --format '{{ '{{' }}.Names{{ '}}' }}' 2>/dev/null | grep -q "^${container_name}$"
}

# Function to wait for container to be healthy
wait_for_container() {
  local container_name="$1"
  local max_wait="${2:-180}"  # Default 180 seconds (3 minutes)
  local elapsed=0

  if ! container_exists "$container_name"; then
    echo "Container $container_name does not exist yet, skipping health check"
    return 0
  fi

  echo "Waiting for $container_name to be healthy (timeout: ${max_wait}s)..."
  while [ $elapsed -lt $max_wait ]; do
    if /usr/bin/docker inspect --format='{{ '{{' }}.State.Health.Status{{ '}}' }}' "$container_name" 2>/dev/null | grep -q "healthy"; then
      echo "$container_name is healthy after ${elapsed}s"
      return 0
    fi
    sleep 5
    elapsed=$((elapsed + 5))
  done

  echo "Warning: $container_name did not become healthy within ${max_wait} seconds"
  return 1
}

# Renew indexer certificate using mTLS
if needs_renewal "$CERT_DIR/wazuh.indexer.pem"; then
  echo "Renewing indexer certificate..."
  /usr/bin/step ca renew --force \
    "$CERT_DIR/wazuh.indexer.pem" \
    "$CERT_DIR/wazuh.indexer-key.pem"
  /usr/bin/chown "$CERT_OWNER:$CERT_GROUP" "$CERT_DIR/wazuh.indexer.pem" "$CERT_DIR/wazuh.indexer-key.pem"
  RESTART_INDEXER=1
else
  echo "Indexer certificate does not need renewal"
fi

# Renew manager certificate using mTLS
if needs_renewal "$CERT_DIR/wazuh.manager.pem"; then
  echo "Renewing manager certificate..."
  /usr/bin/step ca renew --force \
    "$CERT_DIR/wazuh.manager.pem" \
    "$CERT_DIR/wazuh.manager-key.pem"
  /usr/bin/chown "$CERT_OWNER:$CERT_GROUP" "$CERT_DIR/wazuh.manager.pem" "$CERT_DIR/wazuh.manager-key.pem"
  RESTART_MANAGER=1
else
  echo "Manager certificate does not need renewal"
fi

# Renew dashboard backend certificate using mTLS
if needs_renewal "$CERT_DIR/wazuh.dashboard.pem"; then
  echo "Renewing dashboard backend certificate..."
  /usr/bin/step ca renew --force \
    "$CERT_DIR/wazuh.dashboard.pem" \
    "$CERT_DIR/wazuh.dashboard-key.pem"
  /usr/bin/chown "$CERT_OWNER:$CERT_GROUP" "$CERT_DIR/wazuh.dashboard.pem" "$CERT_DIR/wazuh.dashboard-key.pem"
  RESTART_DASHBOARD=1
else
  echo "Dashboard backend certificate does not need renewal"
fi

# Renew admin certificate using mTLS
# Admin cert requires PKCS8 format key for OpenSearch Security plugin
if needs_renewal "$CERT_DIR/admin.pem"; then
  echo "Renewing admin certificate..."

  # Renew certificate using mTLS
  /usr/bin/step ca renew --force \
    "$CERT_DIR/admin.pem" \
    "$CERT_DIR/admin-key.pem"

  # Convert private key to PKCS8 format (required by OpenSearch Security)
  /usr/bin/openssl pkcs8 -inform PEM -outform PEM \
    -in "$CERT_DIR/admin-key.pem" \
    -topk8 -nocrypt -v1 PBE-SHA1-3DES \
    -out "$CERT_DIR/admin-key-pkcs8.pem"

  mv "$CERT_DIR/admin-key-pkcs8.pem" "$CERT_DIR/admin-key.pem"

  /usr/bin/chown "$CERT_OWNER:$CERT_GROUP" "$CERT_DIR/admin.pem" "$CERT_DIR/admin-key.pem"
  # Admin cert doesn't require container restart
else
  echo "Admin certificate does not need renewal"
fi

# Renew dashboard frontend certificate using mTLS
if needs_renewal "$FRONTEND_CERT_DIR/fullchain.pem"; then
  echo "Renewing dashboard frontend certificate..."
  /usr/bin/step ca renew --force \
    "$FRONTEND_CERT_DIR/fullchain.pem" \
    "$FRONTEND_CERT_DIR/privkey.pem"
  /usr/bin/chown "$CERT_OWNER:$CERT_GROUP" "$FRONTEND_CERT_DIR"/*.pem
  /usr/bin/chmod 440 "$FRONTEND_CERT_DIR"/*.pem
  RESTART_DASHBOARD=1
else
  echo "Dashboard frontend certificate does not need renewal"
fi

# Restart containers in order if needed
# Note: Health check failures are logged but don't prevent subsequent restarts
if [ $RESTART_INDEXER -eq 1 ]; then
  if container_exists wazuh.indexer; then
    echo "Restarting wazuh.indexer..."
    /usr/bin/docker restart wazuh.indexer 2>/dev/null || echo "Warning: Failed to restart wazuh.indexer"
    # Indexer needs longer timeout (5 minutes) as OpenSearch can be slow to initialize
    wait_for_container wazuh.indexer 300 || echo "Continuing despite indexer health check timeout..."
  else
    echo "Container wazuh.indexer does not exist yet, skipping restart"
  fi
fi

if [ $RESTART_MANAGER -eq 1 ]; then
  if container_exists wazuh.manager; then
    echo "Restarting wazuh.manager..."
    /usr/bin/docker restart wazuh.manager 2>/dev/null || echo "Warning: Failed to restart wazuh.manager"
    wait_for_container wazuh.manager 180 || echo "Continuing despite manager health check timeout..."
  else
    echo "Container wazuh.manager does not exist yet, skipping restart"
  fi
fi

if [ $RESTART_DASHBOARD -eq 1 ]; then
  if container_exists wazuh.dashboard; then
    echo "Restarting wazuh.dashboard..."
    /usr/bin/docker restart wazuh.dashboard 2>/dev/null || echo "Warning: Failed to restart wazuh.dashboard"
    wait_for_container wazuh.dashboard 180 || echo "Continuing despite dashboard health check timeout..."
  else
    echo "Container wazuh.dashboard does not exist yet, skipping restart"
  fi
fi

echo "Certificate renewal complete"
