name: Release

# Trigger on pushes to main branch (where releases are cut from)
# workflow_dispatch allows manual triggering from GitHub UI
on:
  push:
    branches:
      - main
  workflow_dispatch:

# Minimal permissions by default (security best practice)
# Grant specific permissions only where needed
permissions:
  contents: read

jobs:
  release:
    name: Semantic Release
    runs-on: ubuntu-latest

    # Required permissions for semantic-release to function:
    # - contents: write - Create releases and tags
    # - issues: write - Comment on issues referenced in commits
    # - pull-requests: write - Comment on PRs referenced in commits
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      # Security: Harden runner environment and restrict egress traffic
      # See: https://github.com/step-security/harden-runner
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit # TODO: change to 'egress-policy: block' after reviewing egress traffic
          disable-sudo: true
          disable-file-monitoring: false

      # Checkout the repository
      # fetch-depth: 0 is required for semantic-release to analyze full commit history
      # Action pinned to commit SHA for immutability (security best practice)
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          # Use PAT if you need to trigger other workflows from release commits
          # Otherwise GITHUB_TOKEN is sufficient
          persist-credentials: true

      # Setup Node.js for semantic-release (which is a Node.js tool)
      # Using LTS version for stability
      # Action pinned to commit SHA for immutability (security best practice)
      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: 'lts/*'

      # Install semantic-release and required plugins
      # These are installed fresh each run to avoid version drift
      - name: Install semantic-release
        run: |
          npm install --save-dev \
            semantic-release@^24.0.0 \
            @semantic-release/changelog@^6.0.0 \
            @semantic-release/git@^10.0.0 \
            @semantic-release/github@^11.0.0 \
            conventional-changelog-conventionalcommits@^8.0.0

      # Run semantic-release
      # This step will:
      # 1. Analyze commits since last release using conventional commit format
      # 2. Determine next version number (major.minor.patch)
      # 3. Generate/update CHANGELOG.md
      # 4. Create a git tag
      # 5. Create a GitHub release with release notes
      # 6. Commit the changelog back to the repository
      - name: Run semantic-release
        env:
          # GITHUB_TOKEN is automatically provided by GitHub Actions
          # It has the permissions specified in the job's permissions block
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # GIT_AUTHOR/COMMITTER settings ensure changelog commits are attributed correctly
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com
        run: npx semantic-release

      # Optional: Output release information for debugging
      # Semantic-release sets outputs that can be used in subsequent steps
      - name: Output release info
        if: always()
        run: |
          echo "Release workflow completed"
          echo "Check the releases page for new releases: ${{ github.server_url }}/${{ github.repository }}/releases"
